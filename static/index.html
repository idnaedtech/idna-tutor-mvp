<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>IDNA Tutor MVP</title>
  <style>
    body { font-family: Arial; max-width: 900px; margin: 30px auto; }
    #log { border: 1px solid #ddd; padding: 12px; height: 420px; overflow: auto; white-space: pre-wrap; }
    input { width: 78%; padding: 10px; }
    button { padding: 10px 14px; }
    .meta { color: #666; font-size: 12px; margin-top: 8px; }
  </style>
</head>
<body>
  <h2>IDNA Tutor MVP (Text)</h2>

  <div style="margin: 8px 0;">
    <label for="studentId">Student ID:</label>
    <input id="studentId" type="text" value="s1" style="width: 320px;" />
  </div>

  <div style="margin-bottom:10px;">
    <label for="topicSelect">Topic:</label>
    <select id="topicSelect" style="width: 400px; padding: 10px;"></select>
    <button onclick="start()">Start Session</button>
    <button onclick="resume()">Resume Last Session</button>
  </div>
  <div class="meta" id="meta"></div>
  <div class="meta" id="progress"></div>

  <div id="log"></div>

  <div style="margin-top:10px;">
    <input id="answer" placeholder="type: next / repeat / 4 / 10 / 15 ..." />
    <button id="submit" onclick="send()">Send</button>
    <button id="micBtn" type="button">ðŸŽ¤ Speak</button>
    <span id="micStatus" style="margin-left:8px;"></span>
  </div>

<script>
let sessionId = null;
let topicId = null;

function getStudentId() {
  const el = document.getElementById("studentId");
  return (el?.value || "").trim() || "s1";
}

function add(role, text) {
  const log = document.getElementById("log");
  log.textContent += `${role}: ${text}\n\n`;
  log.scrollTop = log.scrollHeight;
}

async function loadTopics() {
  const res = await fetch("/api/topics");
  const topics = await res.json();

  const sel = document.getElementById("topicSelect");
  sel.innerHTML = "";

  topics.forEach(t => {
    const opt = document.createElement("option");
    opt.value = t.topic_id;
    opt.textContent = t.title || t.topic_id;
    sel.appendChild(opt);
  });
}

loadTopics();

async function updateProgress(studentId, topicId) {
  const r = await fetch(
    `/api/progress?student_id=${studentId}&topic_id=${topicId}`
  );
  const p = await r.json();

  document.getElementById("progress").innerText =
    `Progress (${topicId}): ${p.correct} / ${p.total} (${p.pct}%)`;
}

async function start() {
  const studentId = getStudentId();
  const topic_id = document.getElementById("topicSelect").value;
  if (!topic_id) { alert("Select a topic"); return; }
  
  document.getElementById("log").innerHTML = "";
  
  console.log("START payload", { student_id: studentId, topic_id: topic_id });
  
  try {
    const res = await fetch("/start", {
      method: "POST",
      headers: {"Content-Type":"application/json"},
      body: JSON.stringify({
        student_id: studentId,
        topic_id: topic_id
      })
    });
    
    if (!res.ok) {
      const errText = await res.text();
      add("Error", `API error ${res.status}: ${errText.substring(0, 200)}`);
      return;
    }
    
    const data = await res.json();
    
    // Handle restart-blocked / completed responses from backend
    if (data.state === "COMPLETED" || data.blocked === true) {
      const msg = String(data.tutor || data.message || data.tutor_text || "Topic already completed.");
      add("Tutor", msg);
      document.getElementById("meta").textContent = "session_id: null | question_id: -";
      document.getElementById("answer").disabled = true;
      document.getElementById("submit").disabled = true;
      return;
    }
    
    sessionId = data.session_id;
    topicId = topic_id;
    document.getElementById("meta").textContent = `session_id: ${sessionId} | topic_id: ${topic_id}`;
    document.getElementById("answer").disabled = false;
    document.getElementById("submit").disabled = false;
    
    // Safely extract tutor message
    const msg = String(data.tutor_text || data.message || data.tutor || "Session started.");
    add("Tutor", msg);
    await updateProgress(studentId, topic_id);
  } catch (e) {
    add("Error", `Failed to start session: ${e.message}`);
  }
}

async function resume() {
  const studentId = getStudentId();
  document.getElementById("log").innerHTML = "";
  const res = await fetch(`/api/resume?student_id=${encodeURIComponent(studentId)}`);
  const data = await res.json();

  if (data.status !== "ok") {
    add("Tutor", `No previous session found for student ${studentId}.`);
    return;
  }

  sessionId = data.session_id;
  topicId = data.topic_id;
  document.getElementById("meta").textContent = `session_id: ${data.session_id} | topic_id: ${data.topic_id}`;
  document.getElementById("answer").disabled = false;
  document.getElementById("submit").disabled = false;
  add("Tutor", `Resumed session ${data.session_id} (topic ${data.topic_id}, state ${data.state}).`);
  await updateProgress(studentId, data.topic_id);
}

async function send() {
  if (!sessionId) { alert("Start session first"); return; }
  const studentId = getStudentId();
  const msg = document.getElementById("answer").value.trim();
  if (!msg) return;
  document.getElementById("answer").value = "";
  add("You", msg);

  const r = await fetch("/turn", {
    method: "POST",
    headers: {"Content-Type":"application/json"},
    body: JSON.stringify({student_id: studentId, session_id: sessionId, user_text: msg})
  });
  
  if (!r.ok) {
    const errText = await r.text();
    add("Error", `API error ${r.status}: ${errText.substring(0, 200)}`);
    return;
  }
  
  const data = await r.json();
  
  const tutorText =
    data.tutor_text ??
    data.tutor ??
    data.message ??
    (data.question && (data.question.prompt || data.question)) ??
    "";
  add("Tutor", tutorText || "Continue...");

  // show progress metadata if available
  if (data.question_id || data.topic_id) {
    document.getElementById("meta").textContent =
      `session_id: ${sessionId} | topic_id: ${data.topic_id || "-"} | question_id: ${data.question_id || "-"}`;
  }
  
  // Update progress
  await updateProgress(studentId, topicId);
}

document.getElementById("answer").addEventListener("keydown", (e) => {
  if (e.key === "Enter") send();
});

// ===== Voice Input (Browser Speech-to-Text) =====
const micBtn = document.getElementById("micBtn");
const micStatus = document.getElementById("micStatus");
const answerInput = document.getElementById("answer"); // change if your id differs
const submitBtn = document.getElementById("submit");   // change if your id differs

let recognition = null;
let isListening = false;

function setupSpeech() {
  const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
  if (!SpeechRecognition) {
    console.warn("Speech Recognition not supported");
    micBtn.disabled = true;
    micStatus.textContent = "Voice not supported in this browser.";
    return;
  }

  recognition = new SpeechRecognition();
  recognition.lang = "en-US";        // change later for Hindi/Bengali
  recognition.interimResults = false;
  recognition.maxAlternatives = 1;
  recognition.continuous = false;

  recognition.onstart = () => {
    console.log("Speech recognition started");
    isListening = true;
    micStatus.textContent = "Listening...";
    micBtn.textContent = "â¹ Stop";
  };

  recognition.onend = () => {
    console.log("Speech recognition ended");
    isListening = false;
    micStatus.textContent = "";
    micBtn.textContent = "ðŸŽ¤ Speak";
  };

  recognition.onerror = (e) => {
    console.error("Speech error:", e.error);
    micStatus.textContent = `Voice error: ${e.error}`;
  };

  recognition.onresult = (event) => {
    console.log("Speech result event:", event);
    if (event.results && event.results.length > 0) {
      const transcript = event.results[0][0].transcript;
      console.log("Captured text:", transcript);
      answerInput.value = transcript.trim();
      console.log("Input field updated with:", answerInput.value);
    } else {
      console.warn("No results in event");
    }

    // Optional: auto-submit after speaking
    // submitBtn.click();
  };
}

setupSpeech();

micBtn.addEventListener("click", () => {
  console.log("Mic button clicked. isListening:", isListening, "recognition:", recognition);
  if (!recognition) {
    console.error("Speech recognition not initialized");
    return;
  }
  if (isListening) {
    console.log("Stopping recognition");
    recognition.stop();
  } else {
    console.log("Starting recognition");
    recognition.start();
  }
});
</script>
</body>
</html>
