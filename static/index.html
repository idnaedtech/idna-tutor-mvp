<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>IDNA Tutor MVP</title>
  <style>
    body { font-family: Arial; max-width: 900px; margin: 30px auto; }
    #log { border: 1px solid #ddd; padding: 12px; height: 420px; overflow: auto; white-space: pre-wrap; }
    input { width: 78%; padding: 10px; }
    button { padding: 10px 14px; }
    .meta { color: #666; font-size: 12px; margin-top: 8px; }
  </style>
</head>
<body>
  <h2>IDNA Tutor MVP (Text)</h2>

  <div style="margin: 8px 0;">
    <label for="studentId">Student ID:</label>
    <input id="studentId" type="text" value="s1" style="width: 320px;" />
  </div>

  <div style="margin-bottom:10px;">
    <label for="topicSelect">Topic:</label>
    <select id="topicSelect" style="width: 400px; padding: 10px;"></select>
    <button onclick="start()">Start Session</button>
    <button onclick="resume()">Resume Last Session</button>
  </div>
  <div class="meta" id="meta"></div>
  <div class="meta" id="progress"></div>

  <div id="log"></div>

  <div style="margin-top:10px;">
    <input id="msg" placeholder="type: next / repeat / 4 / 10 / 15 ..." />
    <button onclick="send()">Send</button>
  </div>

<script>
let sessionId = null;
let topicId = null;

function getStudentId() {
  const el = document.getElementById("studentId");
  return (el?.value || "").trim() || "s1";
}

function add(role, text) {
  const log = document.getElementById("log");
  log.textContent += `${role}: ${text}\n\n`;
  log.scrollTop = log.scrollHeight;
}

async function loadTopics() {
  const res = await fetch("/api/topics");
  const topics = await res.json();

  const sel = document.getElementById("topicSelect");
  sel.innerHTML = "";

  topics.forEach(t => {
    const opt = document.createElement("option");
    opt.value = t.topic_id;
    opt.textContent = t.title || t.topic_id;
    sel.appendChild(opt);
  });
}

loadTopics();

async function updateProgress() {
  if (!topicId) return;
  const studentId = getStudentId();
  const res = await fetch(`/api/progress?student_id=${studentId}&topic_id=${topicId}`);
  const data = await res.json();
  document.getElementById("progress").textContent = 
    `Progress (${topicId}): ${data.correct} / ${data.total} (${data.pct}%)`;
}

async function start() {
  const studentId = getStudentId();
  const topic_id = document.getElementById("topicSelect").value;
  if (!topic_id) { alert("Select a topic"); return; }
  
  try {
    const res = await fetch("/start", {
      method: "POST",
      headers: {"Content-Type":"application/json"},
      body: JSON.stringify({
        student_id: studentId,
        topic_id: topic_id
      })
    });
    
    if (!res.ok) {
      const errText = await res.text();
      add("Error", `API error ${res.status}: ${errText.substring(0, 200)}`);
      return;
    }
    
    const data = await res.json();
    sessionId = data.session_id;
    topicId = topic_id;
    document.getElementById("meta").textContent = `session_id: ${sessionId} | topic_id: ${topic_id}`;
    add("Tutor", data.tutor_text);
    await updateProgress();
  } catch (e) {
    add("Error", `Failed to start session: ${e.message}`);
  }
}

async function resume() {
  const studentId = getStudentId();
  const res = await fetch(`/api/resume?student_id=${encodeURIComponent(studentId)}`);
  const data = await res.json();

  if (data.status !== "ok") {
    add("Tutor", `No previous session found for student ${studentId}.`);
    return;
  }

  sessionId = data.session_id;
  topicId = data.topic_id;
  document.getElementById("meta").textContent = `session_id: ${data.session_id} | topic_id: ${data.topic_id}`;
  add("Tutor", `Resumed session ${data.session_id} (topic ${data.topic_id}, state ${data.state}).`);
  await updateProgress();
}

async function send() {
  if (!sessionId) { alert("Start session first"); return; }
  const studentId = getStudentId();
  const msg = document.getElementById("msg").value.trim();
  if (!msg) return;
  document.getElementById("msg").value = "";
  add("You", msg);

  const r = await fetch("/turn", {
    method: "POST",
    headers: {"Content-Type":"application/json"},
    body: JSON.stringify({student_id: studentId, session_id: sessionId, user_text: msg})
  });
  
  if (!r.ok) {
    const errText = await r.text();
    add("Error", `API error ${r.status}: ${errText.substring(0, 200)}`);
    return;
  }
  
  const data = await r.json();
  add("Tutor", data.tutor_text);

  // show progress metadata if available
  if (data.question_id || data.topic_id) {
    document.getElementById("meta").textContent =
      `session_id: ${sessionId} | topic_id: ${data.topic_id || "-"} | question_id: ${data.question_id || "-"}`;
  }
  
  // Update progress
  await updateProgress();
}

document.getElementById("msg").addEventListener("keydown", (e) => {
  if (e.key === "Enter") send();
});
</script>
</body>
</html>
