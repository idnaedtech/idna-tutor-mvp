<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>IDNA Tutor MVP</title>
  <style>
    body { font-family: Arial; max-width: 900px; margin: 30px auto; }
    #log { border: 1px solid #ddd; padding: 12px; height: 420px; overflow: auto; white-space: pre-wrap; }
    input { width: 78%; padding: 10px; }
    button { padding: 10px 14px; }
    .meta { color: #666; font-size: 12px; margin-top: 8px; }
  </style>
</head>
<body>
  <h2>IDNA Tutor MVP (Text)</h2>

  <div style="margin-bottom:10px;">
    <input id="topicId" placeholder="topic_id (e.g., g6_math_add_01)" value="g6_math_add_01" style="width: 400px;" />
    <button onclick="start()">Start Session</button>
  </div>
  <div class="meta" id="meta"></div>

  <div id="log"></div>

  <div style="margin-top:10px;">
    <input id="msg" placeholder="type: next / repeat / 4 / 10 / 15 ..." />
    <button onclick="send()">Send</button>
  </div>

<script>
let sessionId = null;
let studentId = "00000000-0000-0000-0000-000000000001";

function add(role, text) {
  const log = document.getElementById("log");
  log.textContent += `${role}: ${text}\n\n`;
  log.scrollTop = log.scrollHeight;
}

async function start() {
  const topicId = document.getElementById("topicId").value.trim();
  if (!topicId) { alert("Enter topic_id"); return; }
  
  const r = await fetch("/start", {
    method: "POST",
    headers: {"Content-Type":"application/json"},
    body: JSON.stringify({student_id: studentId, topic_id: topicId})
  });
  
  if (!r.ok) {
    const errText = await r.text();
    add("Error", `API error ${r.status}: ${errText.substring(0, 200)}`);
    return;
  }
  
  const data = await r.json();
  sessionId = data.session_id;
  document.getElementById("meta").textContent = `session_id: ${sessionId} | topic_id: ${topicId}`;
  add("Tutor", data.tutor_text);
}

async function send() {
  if (!sessionId) { alert("Start session first"); return; }
  const msg = document.getElementById("msg").value.trim();
  if (!msg) return;
  document.getElementById("msg").value = "";
  add("You", msg);

  const r = await fetch("/turn", {
    method: "POST",
    headers: {"Content-Type":"application/json"},
    body: JSON.stringify({student_id: studentId, session_id: sessionId, user_text: msg})
  });
  
  if (!r.ok) {
    const errText = await r.text();
    add("Error", `API error ${r.status}: ${errText.substring(0, 200)}`);
    return;
  }
  
  const data = await r.json();
  add("Tutor", data.tutor_text);

  // show progress metadata if available
  if (data.question_id || data.topic_id) {
    document.getElementById("meta").textContent =
      `session_id: ${sessionId} | topic_id: ${data.topic_id || "-"} | question_id: ${data.question_id || "-"}`;
  }
}

document.getElementById("msg").addEventListener("keydown", (e) => {
  if (e.key === "Enter") send();
});
</script>
</body>
</html>
