This block is wrong for MVP. It causes your “Let me check → press next again” problem and it also **overwrites the chosen topic**.

Fix it like this:

## What’s wrong (simple)

1. You move to `EVALUATE` immediately and return only “Let me check.”
   ✅ Users hate that.
2. You call `pick_topic(6,"math","en")` inside QUIZ.
   ❌ That ignores `s["topic_id"]` and can switch topics randomly.
3. You set `qid = s["current_question_id"]` but you don’t grade anything here.

---

## What to do instead (simple rule)

When you are in **QUIZ** and the student answers:

* **grade now**
* reply **correct/wrong now**
* then either:

  * move to next question (QUIZ), or
  * give hint (HINT), or
  * reveal/explain (EXPLAIN/REVEAL)

**No EVALUATE state needed.** Evaluation is a function, not a state.

---

## Drop-in replacement (minimal change)

Assumption: you can read the student answer from something like `request.user_text` (or similar). If your field name differs, replace it.

```py
# --- QUIZ: grade immediately and continue ---
if state == tutoring_pb2.FsmState.QUIZ:
    topic_id = s["topic_id"]
    qid = s["current_question_id"]

    # Safety: must have topic + current question
    if not topic_id or not qid:
        _run_async(update_session(request.session_id, state="QUIZ"))
        return tutoring_pb2.TurnResponse(
            session_id=request.session_id,
            next_state=tutoring_pb2.FsmState.QUIZ,
            tutor_text="Pick a topic and start again.",
            attempt_count=attempt_count,
            frustration_counter=frustration,
            intent="error",
            topic_id=topic_id or "",
            question_id=qid or "",
            title=""
        )

    # Load question + answer key from DB
    q = _run_async(get_question_by_id(qid))   # you need this helper if not present
    user_answer = (request.user_text or "").strip()

    is_correct = check_answer(user_answer, q["answer_key"])  # your grading function

    if is_correct:
        # Mark seen + pick next question from SAME topic
        _run_async(mark_seen(student_id=s["student_id"], topic_id=topic_id, question_id=qid))

        next_q = _run_async(get_next_question(student_id=s["student_id"], topic_id=topic_id))

        if not next_q:
            _run_async(update_session(request.session_id, state="COMPLETE", current_question_id=None))
            return tutoring_pb2.TurnResponse(
                session_id=request.session_id,
                next_state=tutoring_pb2.FsmState.COMPLETE,
                tutor_text="✅ Correct. You finished this topic.",
                attempt_count=attempt_count,
                frustration_counter=frustration,
                intent="complete",
                topic_id=topic_id,
                question_id="",
                title=""
            )

        _run_async(update_session(
            request.session_id,
            state="QUIZ",
            current_question_id=next_q["question_id"]
        ))

        return tutoring_pb2.TurnResponse(
            session_id=request.session_id,
            next_state=tutoring_pb2.FsmState.QUIZ,
            tutor_text=f"✅ Correct. Next question: {next_q['prompt']}",
            attempt_count=0,
            frustration_counter=frustration,
            intent="next_question",
            topic_id=topic_id,
            question_id=next_q["question_id"],
            title=next_q.get("title", "")
        )

    # Wrong answer path: give hint first
    _run_async(update_session(request.session_id, state="HINT"))
    return tutoring_pb2.TurnResponse(
        session_id=request.session_id,
        next_state=tutoring_pb2.FsmState.HINT,
        tutor_text=f"❌ Not correct. Hint: {q.get('hint1','Try again.')}",
        attempt_count=attempt_count + 1,
        frustration_counter=frustration + 1,
        intent="hint",
        topic_id=topic_id,
        question_id=qid,
        title=q.get("title", "")
    )
```

---

## The key change you MUST also make

Delete this line completely:

```py
topic = _run_async(pick_topic(6, "math", "en"))
```

You already have `topic_id` in session. Don’t pick a new topic during quiz.

---

## If you want the smallest patch possible (even smaller)

If you don’t want to add helpers now, do this minimum:

* **Remove EVALUATE transition**
* **Return feedback immediately**
* Keep `topic_id = s["topic_id"]`
* Do NOT call `pick_topic(...)`

---

## What I need to finalize this correctly (so you don’t guess)

Paste these (just the function signatures or small snippets):

1. What field contains student answer in `TurnReq`? (`request.text` / `request.user_text` / `request.user_input`?)
2. Your DB functions available: do you already have `get_question_by_id`, `get_next_question`, `mark_seen`? If not, paste `db.py` function list.

Then I’ll give you the exact minimal patch that matches your repo names.
