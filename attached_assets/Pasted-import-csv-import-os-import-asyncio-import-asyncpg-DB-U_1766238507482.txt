import csv
import os
import asyncio
import asyncpg

DB_URL = os.environ.get("DATABASE_URL")  # should already be set in Replit Secrets

UPSERT_CONCEPT = """
insert into concepts(topic_id, grade, subject, language, title, explain_text)
values($1,$2,$3,$4,$5,$6)
on conflict (topic_id) do update set
  grade=excluded.grade,
  subject=excluded.subject,
  language=excluded.language,
  title=excluded.title,
  explain_text=excluded.explain_text;
"""

UPSERT_QUESTION = """
insert into questions(question_id, topic_id, qtype, prompt, answer_key, hint1, hint2, reveal_explain)
values($1,$2,$3,$4,$5,$6,$7,$8)
on conflict (question_id) do update set
  topic_id=excluded.topic_id,
  qtype=excluded.qtype,
  prompt=excluded.prompt,
  answer_key=excluded.answer_key,
  hint1=excluded.hint1,
  hint2=excluded.hint2,
  reveal_explain=excluded.reveal_explain;
"""

async def main():
    if not DB_URL:
        raise RuntimeError("DATABASE_URL missing. Add it in Replit Secrets.")
    conn = await asyncpg.connect(DB_URL)
    try:
        with open("content.csv", newline="", encoding="utf-8") as f:
            rows = list(csv.DictReader(f))

        concepts_done = set()
        q_count = 0

        for r in rows:
            topic_id = r["topic_id"].strip()
            if topic_id not in concepts_done:
                await conn.execute(
                    UPSERT_CONCEPT,
                    topic_id,
                    int(r["grade"]),
                    r["subject"].strip(),
                    r["language"].strip(),
                    r["title"].strip(),
                    r["explain_text"].strip(),
                )
                concepts_done.add(topic_id)

            await conn.execute(
                UPSERT_QUESTION,
                r["question_id"].strip(),
                topic_id,
                r.get("qtype", "short").strip(),
                r["prompt"].strip(),
                r["answer_key"].strip(),
                r["hint1"].strip(),
                r["hint2"].strip(),
                r["reveal_explain"].strip(),
            )
            q_count += 1

        print(f"Loaded concepts: {len(concepts_done)}")
        print(f"Loaded questions: {q_count}")
    finally:
        await conn.close()

if __name__ == "__main__":
    asyncio.run(main())
